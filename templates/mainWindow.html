<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAPYBARA Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Simple styles as requested */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            background-color: #f5f5f5;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        main {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: 300px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .contact, .group {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .contact-info, .group-info {
            margin-left: 10px;
            flex: 1;
        }
        .message {
            margin: 5px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 70%;
        }
        .sent {
            background-color: #dcf8c6; /* Зеленый фон для отправителя */
            align-self: flex-end;
        }
        .received {
            background-color: #e3f2fd; /* Синий фон для получателя */
            align-self: flex-start;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .message-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }
        .message-input textarea {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
        }
        .send-btn {
            margin-left: 10px;
            background-color: orange;
            color: white;
            border: none;
            border-radius: 50%;
            height: 36px;
            width: 36px;
            cursor: pointer;
        }
        .attach-btn {
            margin-left: 10px;
            background-color: green;
            color: white;
            border: none;
            border-radius: 50%;
            height: 36px;
            width: 36px;
            cursor: pointer;
        }
        .filters {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .filter-btn {
            margin-right: 5px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
            background-color: white;
        }
        .active {
            background-color: #e3f2fd;
        }
        .search-bar {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .search-bar input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 15px;
        }
        .chat-options {
            color: yellow;
            cursor: pointer;
            font-size: 24px;
            margin-left: 10px;
        }
        .settings-btn {
            color: yellow;
            cursor: pointer;
            font-size: 24px;
        }
        .message-status {
            font-size: 12px;
            color: #888;
            text-align: right;
        }
        .chat-actions {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        .action-btn {
            margin-right: 5px;
            padding: 2px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f8f8;
            cursor: pointer;
        }
        .action-btn:hover {
            background-color: #e0e0e0;
        }
        .delete-group-btn {
            color: #f44336;
        }
        .add-user-btn {
            padding: 3px 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .group-info-header {
            padding: 10px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        .members-list {
            padding: 10px;
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f5f5f5;
        }
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .member-info {
            flex: 1;
        }
        .role-badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .role-badge.creator {
            background-color: #ffd700;
            color: #333;
        }
        .role-badge.admin {
            background-color: #4CAF50;
            color: white;
        }
        .group-info-header {
            padding: 15px;
            font-weight: bold;
            font-size: 18px;
            color: #333;
            border-bottom: 1px solid #ddd;
            background-color: #f9f9f9;
        }
        
        .members-list {
            padding: 0;
            margin: 0;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .member-item:hover {
            background-color: #f5f5f5;
        }
        
        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 1px solid #eee;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        
        .role-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
            display: inline-block;
        }
        
        .role-badge.creator {
            background-color: #ffd700;
            color: #333;
        }
        
        .role-badge.admin {
            background-color: #4CAF50;
            color: white;
        }
        
        .chat-actions {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        
        .action-btn {
            margin-right: 8px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f8f8;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        
        .action-btn:hover {
            background-color: #e0e0e0;
        }
        
        .delete-group-btn {
            color: #f44336;
        }
        
        .add-member-btn::before {
            content: "+";
            margin-right: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header>
        <div class="user-info">
            <img src="{{ current_user.avatar or url_for('static', filename='img/default-avatar.png') }}" alt="Avatar" class="avatar">
            <span>{{ current_user.name }}</span>
        </div>
        <div class="actions">
            <a href="{{ url_for('settings') }}" class="settings-btn">&#9776;</a>
            <a href="{{ url_for('logout') }}" class="logout-btn">Выйти</a>
        </div>
    </header>
    
    <main>
        <section class="sidebar">
            <!-- Chat type filters -->
            <div class="filters">
                <button class="filter-btn active">All</button>
                <button class="filter-btn">Directs</button>
                <button class="filter-btn">Groups</button>
                
                <div style="margin-left: auto;">
                    <button class="filter-btn">All</button>
                    <button class="filter-btn">Unread</button>
                    <button class="filter-btn">Read</button>
                </div>
            </div>
            
            <!-- Search bar -->
            <div class="search-bar">
                <input type="text" placeholder="Search">
            </div>
            
            
            <div class="tab-content contacts active">
                <ul class="contact-list">
                    {% for user in friends %}
                    <li class="contact" data-user-id="{{ user.id }}">
                        <img src="{{ user.avatar or url_for('static', filename='img/default-avatar.png') }}" alt="Avatar" class="avatar" onerror="this.src='https://via.placeholder.com/50x50?text=User'">
                        <div class="contact-info">
                            <span class="name">{{ user.nickname or user.name }}</span>
                            <div class="last-message">
                                <span class="preview">Start a conversation</span>
                                <span class="time"></span>
                            </div>
                        </div>
                    </li>
                    {% else %}
                    <li class="no-contacts">No friends yet. Add friends in Settings.</li>
                    {% endfor %}
                </ul>
            </div>
            
            <div class="tab-content groups">
                <ul class="group-list">
                    {% for group in user_groups %}
                    <li class="group" data-group-id="{{ group.id }}">
                        <img src="{{ group.avatar or url_for('static', filename='img/default-group.png') }}" alt="Group" class="avatar">
                        <div class="group-info">
                            <span class="name">{{ group.name }}</span>
                            <div class="last-message">
                                <span class="preview">Последнее сообщение...</span>
                                <span class="time">14:30</span>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </section>
        
        <section class="chat">
            <div class="chat-header">
                <span class="chat-title">Выберите чат, чтобы начать общение</span>
                <div class="chat-actions" style="display: none;">
                    <button class="action-btn add-member-btn" title="Add Member">+Add member</button>
                    <button class="action-btn edit-group-btn" title="Edit Group Name">✏️</button>
                    <button class="action-btn delete-group-btn" title="Delete Group" style="display: none;">🗑️</button>
                </div>
                <span class="chat-options">⚪</span>
            </div>
            
            <!-- Group edit dialog -->
            <div class="edit-group-dialog" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 10;">
                <h3>Edit Group Name</h3>
                <input type="text" id="edit-group-name" class="form-control" style="margin: 10px 0;">
                <div>
                    <button class="save-group-name">Save</button>
                    <button class="cancel-edit">Cancel</button>
                </div>
            </div>
            
            <!-- Add member dialog -->
            <div class="add-member-dialog" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 10; width: 300px;">
                <h3>Add Group Member</h3>
                <input type="text" id="new-member-name" placeholder="Enter name or email" class="form-control" style="margin: 10px 0;">
                <div id="user-search-results" style="max-height: 200px; overflow-y: auto;"></div>
                <div style="margin-top: 10px;">
                    <button class="close-add-member">Cancel</button>
                </div>
            </div>
            
            <div class="messages-container">

                
            
            <div class="message-input">
                <textarea placeholder="Введите сообщение..."></textarea>
                <button class="attach-btn">&#9776;</button>
                <button class="send-btn">▶</button>
            </div>
        </section>
    </main>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // Simple JavaScript for tab switching
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Hide all tab contents
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Show the selected tab content
                    const tabName = this.getAttribute('data-tab');
                    document.querySelector(`.tab-content.${tabName}`).classList.add('active');
                });
            });
            
            // Filter buttons click event
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const btnGroup = this.parentElement.querySelectorAll('.filter-btn');
                    btnGroup.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Group double-click handler
            document.querySelectorAll('.group').forEach(group => {
                group.addEventListener('dblclick', function() {
                    const groupId = this.getAttribute('data-group-id');
                    loadGroupDetails(groupId);
                });
            });
        });
        
        // Load group details
        function loadGroupDetails(groupId) {
            fetch(`/get_group_details/${groupId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Set the chat title to the group name
                        document.querySelector('.chat-title').textContent = data.group.name;
                        
                        // Configure UI based on user role
                        const chatActions = document.querySelector('.chat-actions');
                        chatActions.style.display = 'flex';
                        
                        // All members can see Add member and Edit buttons
                        document.querySelector('.add-member-btn').style.display = 'inline-block';
                        document.querySelector('.edit-group-btn').style.display = 'inline-block';
                        
                        // Only creator can delete the group
                        document.querySelector('.delete-group-btn').style.display = 
                            data.group.is_creator ? 'inline-block' : 'none';
                        
                        // Store the current group ID for later operations
                        document.querySelector('.chat').dataset.groupId = groupId;
                        
                        // Display members in the chat area
                        displayGroupMembers(data.group.members, data.group.is_creator);
                        
                        // Set up event handlers for the buttons
                        setupGroupActionButtons(groupId);
                    }
                    else {
                        alert(data.message || 'Failed to load group details');
                    }
                })
                .catch(error => {
                    console.error('Error loading group details:', error);
                });
        }
        
        // Function to display group members in the chat with improved formatting
        function displayGroupMembers(members, isCreator) {
            const messagesContainer = document.querySelector('.messages-container');
            
            // Clear previous content
            messagesContainer.innerHTML = '';
            
            // Add group info header
            const groupInfoHeader = document.createElement('div');
            groupInfoHeader.className = 'group-info-header';
            groupInfoHeader.textContent = isCreator ? 'Your Group Members:' : 'Group Members:';
            messagesContainer.appendChild(groupInfoHeader);
            
            // Create a members list
            const membersList = document.createElement('div');
            membersList.className = 'members-list';
            
            // Sort members to show creator first, then admins, then regular members
            const sortedMembers = [...members].sort((a, b) => {
                if (a.is_creator) return -1;
                if (b.is_creator) return 1;
                if (a.is_admin && !b.is_admin) return -1;
                if (!a.is_admin && b.is_admin) return 1;
                return 0;
            });
            
            sortedMembers.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                
                let roleLabel = '';
                if (member.is_creator) {
                    roleLabel = '<span class="role-badge creator">Creator</span>';
                } else if (member.is_admin) {
                    roleLabel = '<span class="role-badge admin">Admin</span>';
                }
                
                memberItem.innerHTML = `
                    <img src="${member.avatar || 'https://via.placeholder.com/40x40?text=User'}" 
                         alt="${member.name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/40x40?text=User'">
                    <div class="member-info">
                        <div class="member-name">${member.nickname || member.name} ${roleLabel}</div>
                    </div>
                `;
                
                membersList.appendChild(memberItem);
            });
            
            messagesContainer.appendChild(membersList);
        }
        
        // Set up group action buttons with role-based permissions - updated to allow all members
        function setupGroupActionButtons(groupId) {
            // Add member button - visible to all members
            const addMemberBtn = document.querySelector('.add-member-btn');
            addMemberBtn.onclick = function() {
                showAddMemberDialog(groupId);
            };
            
            // Edit group name button - visible to all members
            const editGroupBtn = document.querySelector('.edit-group-btn');
            editGroupBtn.onclick = function() {
                const currentName = document.querySelector('.chat-title').textContent;
                document.getElementById('edit-group-name').value = currentName;
                document.querySelector('.edit-group-dialog').style.display = 'block';
            };
            
            // Delete group button remains for creator only
            const deleteGroupBtn = document.querySelector('.delete-group-btn');
            if (deleteGroupBtn.style.display !== 'none') {
                deleteGroupBtn.onclick = function() {
                    if (confirm('Are you sure you want to delete this group?')) {
                        deleteGroup(groupId);
                    }
                };
            }
            
            // Save edited group name button
            document.querySelector('.save-group-name').onclick = function() {
                const newName = document.getElementById('edit-group-name').value.trim();
                if (newName) {
                    editGroupName(groupId, newName);
                    document.querySelector('.edit-group-dialog').style.display = 'none';
                }
            };
            
            // Cancel edit button
            document.querySelector('.cancel-edit').onclick = function() {
                document.querySelector('.edit-group-dialog').style.display = 'none';
            };
            
            // Close add member dialog
            document.querySelector('.close-add-member').onclick = function() {
                hideAddMemberDialog();
            };
        }
        
        // Show add member dialog with improved UI
        function showAddMemberDialog(groupId) {
            const dialog = document.querySelector('.add-member-dialog');
            dialog.style.display = 'block';
            
            const searchInput = document.getElementById('new-member-name');
            searchInput.value = '';
            searchInput.focus();
            
            // Clear previous search results
            document.getElementById('user-search-results').innerHTML = '';
            
            // Set up search input event
            searchInput.oninput = function() {
                const query = this.value.trim();
                if (query.length >= 2) {
                    searchUsersForGroup(query, groupId);
                } else {
                    document.getElementById('user-search-results').innerHTML = 
                        '<div class="search-instruction">Enter at least 2 characters to search</div>';
                }
            };
        }
        
        // Hide add member dialog
        function hideAddMemberDialog() {
            document.querySelector('.add-member-dialog').style.display = 'none';
            document.getElementById('new-member-name').value = '';
            document.getElementById('user-search-results').innerHTML = '';
        }
        
        // Search users for adding to group - improved to match the requirements
        function searchUsersForGroup(query, groupId) {
            const resultsContainer = document.getElementById('user-search-results');
            resultsContainer.innerHTML = '<div class="searching">Searching...</div>';
            
            fetch(`/search_users?q=${encodeURIComponent(query)}&group_id=${groupId}`)
                .then(response => response.json())
                .then(data => {
                    resultsContainer.innerHTML = '';
                    
                    if (!data.success) {
                        resultsContainer.innerHTML = `<div class="error-message">${data.message || 'Error searching users'}</div>`;
                        return;
                    }
                    
                    if (data.users.length === 0) {
                        resultsContainer.innerHTML = '<div class="no-results">No matching users found</div>';
                        return;
                    }
                    
                    // Display matching users with add buttons
                    data.users.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-search-item';
                        
                        userItem.innerHTML = `
                            <img src="${user.avatar || 'https://via.placeholder.com/30x30?text=U'}" 
                                 alt="${user.name}" class="search-user-avatar" 
                                 onerror="this.src='https://via.placeholder.com/30x30?text=U'">
                            <div class="search-user-info">
                                <div class="search-user-name">${user.name}</div>
                                <div class="search-user-email">${user.email || ''}</div>
                            </div>
                            <button class="add-user-btn" title="Add to group" data-user-id="${user.id}">✓</button>
                        `;
                        
                        resultsContainer.appendChild(userItem);
                    });
                    
                    // Add event handlers to the Add buttons
                    document.querySelectorAll('.add-user-btn').forEach(btn => {
                        btn.onclick = function() {
                            addGroupMember(groupId, this.getAttribute('data-user-id'));
                        };
                    });
                })
                .catch(error => {
                    resultsContainer.innerHTML = '<div class="error-message">Error searching users</div>';
                    console.error('Error:', error);
                });
        }
        
        // Add a member to the group - update to handle success feedback better
        function addGroupMember(groupId, userId) {
            // Show loading state on button
            const button = document.querySelector(`.add-user-btn[data-user-id="${userId}"]`);
            const originalText = button.textContent;
            button.textContent = '...';
            button.disabled = true;
            
            fetch('/add_group_member', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    group_id: groupId,
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success state
                    button.textContent = '✓';
                    button.style.backgroundColor = '#4CAF50';
                    button.style.color = 'white';
                    
                    // Briefly show success message
                    const userItem = button.closest('.user-search-item');
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-message';
                    successMsg.textContent = 'Added successfully!';
                    userItem.appendChild(successMsg);
                    
                    // Hide dialog after delay
                    setTimeout(() => {
                        hideAddMemberDialog();
                        // Refresh group details to show new member
                        loadGroupDetails(groupId);
                    }, 1000);
                } else {
                    alert(data.message || 'Failed to add member');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error adding member:', error);
                alert('An error occurred while adding the member');
                button.textContent = originalText;
                button.disabled = false;
            });
        }
        
        // Delete a group
        function deleteGroup(groupId) {
            fetch('/delete_group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    group_id: groupId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Group deleted successfully!');
                    // Remove the group from the list in the UI
                    document.querySelector(`.group[data-group-id="${groupId}"]`).remove();
                    // Reset the chat panel
                    document.querySelector('.chat-title').textContent = 'Выберите чат, чтобы начать общение';
                    document.querySelector('.chat-actions').style.display = 'none';
                } else {
                    alert(data.message || 'Failed to delete group');
                }
            })
            .catch(error => {
                console.error('Error deleting group:', error);
                alert('An error occurred while deleting the group');
            });
        }
        
        // Edit group name
        function editGroupName(groupId, newName) {
            fetch('/edit_group_name', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    group_id: groupId,
                    name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the group name in the UI
                    document.querySelector('.chat-title').textContent = newName;
                    document.querySelector(`.group[data-group-id="${groupId}"] .name`).textContent = newName;
                } else {
                    alert(data.message || 'Failed to update group name');
                }
            })
            .catch(error => {
                console.error('Error updating group name:', error);
                alert('An error occurred while updating the group name');
            });
        }
    </script>

    <!-- Add improved styles for the member search UI -->
    <style>
        /* ...existing styles... */
        
        .add-member-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            z-index: 10;
            width: 350px;
        }
        
        .add-member-dialog h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        #new-member-name {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        #user-search-results {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .user-search-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .search-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        .search-user-info {
            flex: 1;
        }
        
        .search-user-name {
            font-weight: bold;
        }
        
        .search-user-email {
            font-size: 12px;
            color: #777;
        }
        
        .add-user-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            border: none;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-user-btn:hover {
            background-color: #4CAF50;
            color: white;
        }
        
        .close-add-member {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 4px;
            color: #333;
            cursor: pointer;
            font-size: 14px;
            display: block;
            margin: 0 auto;
        }
        
        .close-add-member:hover {
            background-color: #e0e0e0;
        }
        
        .searching, .no-results, .search-instruction, .error-message {
            padding: 10px;
            text-align: center;
            color: #666;
        }
        
        .error-message {
            color: #f44336;
        }
        
        .success-message {
            color: #4CAF50;
            text-align: center;
            width: 100%;
            padding: 5px;
            margin-top: 5px;
        }
    </style>
</body>
</html>